generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String   @unique
  password  String
  role      Role     @default(USER)
  avatar    String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  playlists            Playlist[]
  favorites            Favorite[]
  notifications        Notification[]
  listens              Listen[]
  refreshTokens        RefreshToken[]
  artistProfile        Artist?
  followedPlaylists    PlaylistFollower[]
  reviewedVerifications VerificationRequest[] @relation("ReviewedBy")

  @@map("users")
}

model Artist {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique @map("user_id")
  bio         String?  @db.Text
  verified    Boolean  @default(false)
  totalPlays  BigInt   @default(0) @map("total_plays")
  createdAt   DateTime @default(now()) @map("created_at")
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  albums                Album[]
  tracks                Track[]
  verificationRequests  VerificationRequest[]

  @@index([userId])
  @@map("artists")
}

model Album {
  id          Int      @id @default(autoincrement())
  title       String
  artistId    Int      @map("artist_id")
  coverImage  String?  @map("cover_image")
  releaseDate DateTime @default(now()) @map("release_date")
  createdAt   DateTime @default(now()) @map("created_at")

  artist      Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  tracks      Track[]

  @@index([artistId])
  @@map("albums")
}

model Track {
  id         Int         @id @default(autoincrement())
  title      String
  artistId   Int?        @map("artist_id")
  artistName String      @map("artist_name")
  albumId    Int?        @map("album_id")
  genreId    Int         @map("genre_id")
  duration   Int
  filePath   String      @map("file_path")
  coverImage String?     @map("cover_image")
  plays      Int         @default(0)
  status     TrackStatus @default(APPROVED)
  createdAt  DateTime    @default(now()) @map("created_at")

  artist    Artist?   @relation(fields: [artistId], references: [id])
  album     Album?    @relation(fields: [albumId], references: [id])
  genre     Genre     @relation(fields: [genreId], references: [id])
  playlists PlaylistTrack[]
  favorites Favorite[]
  listens   Listen[]

  @@index([artistId])
  @@index([albumId])
  @@index([genreId])
  @@map("tracks")
}

model Genre {
  id    Int    @id @default(autoincrement())
  name  String @unique
  slug  String @unique
  tracks Track[]

  @@map("genres")
}

model Playlist {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  name        String
  description String?
  isPublic    Boolean  @default(true) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")

  user      User              @relation(fields: [userId], references: [id])
  tracks    PlaylistTrack[]
  followers PlaylistFollower[]

  @@index([userId])
  @@map("playlists")
}

model PlaylistTrack {
  playlistId Int @map("playlist_id")
  trackId    Int @map("track_id")
  addedAt    DateTime @default(now()) @map("added_at")

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  track    Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@id([playlistId, trackId])
  @@map("playlist_tracks")
}

model PlaylistFollower {
  userId     Int      @map("user_id")
  playlistId Int      @map("playlist_id")
  followedAt DateTime @default(now()) @map("followed_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  @@id([userId, playlistId])
  @@map("playlist_followers")
}

model Favorite {
  userId    Int      @map("user_id")
  trackId   Int      @map("track_id")
  createdAt DateTime @default(now()) @map("created_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@id([userId, trackId])
  @@map("favorites")
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  type      String
  content   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model Listen {
  id        Int      @id @default(autoincrement())
  userId    Int?     @map("user_id")
  trackId   Int      @map("track_id")
  playedAt  DateTime @default(now()) @map("created_at")

  user  User? @relation(fields: [userId], references: [id])
  track Track @relation(fields: [trackId], references: [id])

  @@index([userId])
  @@index([trackId])
  @@index([playedAt])
  @@map("listens")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model VerificationRequest {
  id          Int                @id @default(autoincrement())
  artistId    Int                @map("artist_id")
  status      VerificationStatus @default(PENDING)
  reason      String?            @db.Text
  submittedAt DateTime           @default(now()) @map("submitted_at")
  reviewedAt  DateTime?          @map("reviewed_at")
  reviewedBy  Int?               @map("reviewed_by")
  notes       String?            @db.Text

  artist   Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)
  reviewer User?  @relation("ReviewedBy", fields: [reviewedBy], references: [id])

  @@index([artistId])
  @@index([status])
  @@map("verification_requests")
}

// Analytics Models
model DailyPlays {
  id        Int      @id @default(autoincrement())
  date      DateTime @db.Date
  trackId   Int?     @map("track_id")
  count     Int      @default(0)
  
  @@index([date])
  @@index([trackId])
  @@map("daily_plays")
}

enum Role {
  USER
  ADMIN
  ARTIST
  GUEST
}

enum TrackStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}
